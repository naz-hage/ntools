<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- Reference: https://learn.microsoft.com/en-us/visualstudio/msbuild/walkthrough-using-msbuild?view=vs-2022 -->

	<Import Project="$(ProgramFiles)\nbuild\common.targets"/>
	
	<PropertyGroup>
        <!-- This is the folder where the *.sln resides-->
		<SolutionName>ntools</SolutionName>
        <!-- This is the location when the app deployed or installed -->
        <DeploymentFolder>$(ProgramFiles)\$(SolutionName)</DeploymentFolder>
	</PropertyGroup>
	
	
    <Target Name="ARTIFACTS">
      <PropertyGroup>
        <ArtifactsFolder>$(ArtifactsDir)\$(SolutionName)\release\$(VERSION)</ArtifactsFolder>
		
      </PropertyGroup>  
      <ItemGroup>
            <BinaryFiles Include="
                        $(SolutionDir)\Release\*.exe;
                        $(SolutionDir)\Release\*.exe.config;
                        $(SolutionDir)\Release\*.json;  
                        $(SolutionDir)\Release\*.dll"
						 
                    Exclude="
						$(SolutionDir)\Release\**\*.pdb;
						$(SolutionDir)\Release\testhost.*"
						/>

            <DataFiles Include="
                       $(SolutionDir)\Release\Data\*.json"
                      />

            <TestFiles Include="
                       $(SolutionDir)\Debug\**\*.*;
                       " />

		    <ArtifactsBlobs Include = "$(ArtifactsFolder)\**\*.*" />

            <RunTimesNetStandard20 Include = "
								   $(SolutionDir)\Release\netstandard2.0\*.*"
                                    Exclude="
						            $(SolutionDir)\Release\**\*.pdb"
						            />
		  
        </ItemGroup>
		
		<RemoveDir Directories="$(ArtifactsFolder)" />
		
        <Message Text="==> DONE"/>
    </Target>

	<Target Name="GIT_BRANCH">
		<Exec Command='$(NbuildExe) -git getbranch -project $(SolutionName) > NUL' />
		<ReadLinesFromFile File="$(BranchFile)">
			<Output TaskParameter="Lines" PropertyName="GIT_BRANCH" />
		</ReadLinesFromFile>
		<Message Text="GIT_BRANCH = $(GIT_BRANCH)"/>
		<Message Text="==> DONE"/>
	</Target>

	<Target Name="GIT_PUSH" DependsOnTargets="GIT_BRANCH">
		<ReadLinesFromFile File="$(VersionFile)">
			<Output TaskParameter="Lines" PropertyName="VERSION" />
		</ReadLinesFromFile>
		<Exec Command='$(NbuildExe) -git settag -project $(SolutionName) -tag $(VERSION) -branch $(GIT_BRANCH) > TAG.TXT' />
		<Exec Command='cd $(SolutionDir) &amp; git commit -a -m "Automated tag $(VERSION)" &amp; exit 0' />
		<Exec Command='cd $(SolutionDir) &amp; git tag -a $(VERSION) HEAD -m "Automated Tag" &amp; exit 0' />
		<Exec Command='cd $(SolutionDir) &amp; git pull --rebase &amp; exit 0' />
		<Exec Command='cd $(SolutionDir) &amp; git push origin --tags &amp; exit 0' />
		<Exec Command='cd $(SolutionDir) &amp; git push origin &amp; exit 0' />
		<Exec Command='cd $(SolutionDir) &amp; git status &amp; exit 0' />

		<Message Text="==> DONE"/>
	</Target>

	<Target Name="NUGET_PACK" DependsOnTargets="VARIABLES">
		<Exec Command='$(NugetExe) pack $(SolutionDir)\launcher\ntools-launcher.nuspec -Version $(VERSION) -OutputDirectory $(NugetPackagePath)'/>
		<Exec Command='rd $(LocalNugetFeed)\ntools-launcher\$(VERSION) /s /q'/>
		<Exec Command='$(NugetExe) add $(NugetPackagePath)\$(SolutionName)-launcher.$(VERSION).nupkg -Source "$(LocalNugetFeed)"'/>
		<Message Text="==> DONE"/>
		</Target>
	
	<Target Name="NUGET_PUBLISH" DependsOnTargets='VARIABLES'>
		<ReadLinesFromFile File="$(ApiKeyFile)">
		<Output TaskParameter="Lines" PropertyName="NUGET_API_KEY" />
		</ReadLinesFromFile>
		<MSBuild Projects="$(SolutionDir)\launcher\launcher.csproj" Properties="Configuration=$(TargetRelease);Platform=Any CPU;Version=$(VERSION);AssemblyVersion=$(VERSION)"/>
		<Exec Command='$(NugetExe) push $(NugetPackagePath)\$(SolutionName)-launcher.$(VERSION).nupkg -Source https://api.nuget.org/v3/index.json -ApiKey $(NUGET_API_KEY)'/>
		<Message Text="==> DONE"/>	
	</Target>

	<Target Name="GET_TAG" DependsOnTargets="GIT_BRANCH">
		<Exec Command='$(NbuildExe) -git gettag -project $(SolutionName) -branch $(GIT_BRANCH)'/>
		<Message Text="==> DONE"/>	
	</Target>

</Project>

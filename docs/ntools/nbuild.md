- [Usage](#usage)
- [nbuild.targets](#nbuildtargets)
- [common.targets](#commontargets)
- [Examples](../usage.md)
---

# Nbuild

 - `Nbuild` (`nb.exe`) is a wrapper for [MSBuild](https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild) that simplifies building solutions and provides a way to define and run custom targets.
 - `Nb.exe` is also a command line tool that installs the development tools and runtimes required to build and test any solution.
       - To build a target type `Nb.exe [Target Name]`
      - The list of targets is generated by running the `Nb.exe -c targets` command.
  - `Nb.exe` expects the [nbuild.targets](#nbuildtargets) file to be present in the solution folder.

Below is a full list of options that can be used with `Nb.exe`:
### Usage
```cmd
 Nb.exe [-c value] [-json value] [-v value]
  - c    : Specifies the command to execute. Possible values: targets, install, uninstall, download, list.
         targets         -> Lists available targets and saves them in the targets.md file.
         install         -> Downloads and installs apps specified in the -json option.
         uninstall       -> Uninstalls apps specified in the -json option.
         download        -> Downloads apps specified in the -json option.
         list            -> Lists apps specified in the -json option.
         ----
         - By default, the -json option points to the `ntools` deployment folder: $(ProgramFiles)\build\ntools.json.
         - The install, uninstall, and download commands require admin privileges to run. (string, default=)
  - json : Specifies the JSON file that holds the list of apps. Only valid for the install, download, and list commands.
         Sample JSON file: https://github.com/naz-hage/ntools/blob/main/DevSetup/app-Ntools.json
          (string, default=$(ProgramFiles)\nbuild\NTools.json)
  - v    : Optional parameter which sets the console output verbose level
         ----
         - if no command line options are specified with the -v option , i.e.: 'Nb.exe staging -v true`
           `Nb` will run an MSbuild target `staging` defined in a `nbuild.targets` file which present in the solution folder.
           Run `Nb.exe -t Targets` to list the available targets.
         -v Possible Values: (true or false, default=False)
```

**If the -json option is not specified, the default json file `$(ProgramFiles)\Nbuild\NTools.json` is used**. 

### nbuild.targets
- `nbuild.targets` is a MSBuild project file that imports `common.targets`
- `nbuild.targets` must include the `SolutionName` and `DeploymentFolder` [property](#required-properties). It should also define the [ARTIFACTS(](#artifacts) target. 
- `nbuild.targets` imports the [common.targets](#commontargets) file located in the `$(ProgramFiles)\Nbuild` folder. The `ntools` repository includes multiple target files, which can be found in the [targets](nbuild-targets.md) file.
- `nbuild.targets` can include any additional properties and targets that are specific to the solution.  
- `nbuild.targets` file is located in the solution folder.

### Required Properties
- The following properties are required in `nbuild.targets`:
    - SolutionName: The name of the solution file.
```xml
<PropertyGroup>
  <!--The GUID should be replaced with the solution name-->
  <SolutionName>$([System.IO.Path]::GetFileNameWithoutExtension('$(MSBuildProjectDirectory)'))</SolutionName>
  <DeploymentFolder>$(ProgramFiles)\Nbuild</DeploymentFolder>
</PropertyGroup>
```

### Artifacts
- The following target is required in `nbuild.targets`:
    - ARTIFACTS: The folder where the artifacts are copied to.
```xml
<!--Setup the ARTIFACTS folders for binaries and test results - override -->
    <Target Name="ARTIFACTS" DependsOnTargets="TAG">
      <PropertyGroup>
		 <ArtifactsSolutionFolder>$(ArtifactsDir)\$(SolutionName)</ArtifactsSolutionFolder>
		 <SetupFolder>$(ArtifactsSolutionFolder)\release</SetupFolder>
        <ArtifactsFolder>$(ArtifactsSolutionFolder)\$(TargetRelease)\$(ProductVersion)</ArtifactsFolder>
		<ArtifactsTestResultsFolder>$(ArtifactsSolutionFolder)\TestResults\$(ProductVersion)</ArtifactsTestResultsFolder>
      </PropertyGroup>  
      <ItemGroup>
            <BinaryFiles 
						Exclude="
						 $(SolutionDir)\$(TargetRelease)\**\*.pdb;
						 $(SolutionDir)\$(TargetRelease)\test.*;
						 $(SolutionDir)\$(TargetRelease)\*test*;
						 $(SolutionDir)\$(TargetRelease)\Nuget*;
						 $(SolutionDir)\$(TargetRelease)\*CodeCoverage*"

						Include="
                        $(SolutionDir)\$(TargetRelease)\*.exe;
                        $(SolutionDir)\$(TargetRelease)\*.exe.config;
                        $(SolutionDir)\$(TargetRelease)\*.json;
						$(SolutionDir)\Nbuild\resources\*.targets;
						$(SolutionDir)\Nbuild\resources\*.ps1;
						$(SolutionDir)\Nbuild\resources\*.json;
                        $(SolutionDir)\$(TargetRelease)\*.dll"
						/>

            <RunTimesNetStandard20 Include = "
								   $(SolutionDir)\$(TargetRelease)\netstandard2.0\*.*"
                                    Exclude="
						            $(SolutionDir)\$(TargetRelease)\**\*.pdb"
						            />
        </ItemGroup>
		
        <Message Text="==> DONE"/>
    </Target>
```
                    
### common.targets
- The `common.targets` file includes all the defaults targets needed to build, test and deploy a solution.  The `common.targets` file is located in the `$(ProgramFiles)\Nbuild` folder.  The `nbuild.targets` file in the solution folder imports the `common.targets` file

Below is list of common targets that are defined in the `common.targets` file

| **Target Name** | **Description** |
| --- | --- |
| PROPERTIES          | Common properties that will be used by all targets |
| CLEAN               | Clean up the project and artifacts folder |
| INSTALL_DEP         | Install dependencies |
| TELEMETRY_OPT_OUT   | Opt out of the DOTNET_CLI_TELEMETRY_OPTOUT - move to common |
| STAGING             | Create a staging package for testing |
| PRODUCTION          | Create a production package for release |
| STAGING_DEPLOY      | Create a staging package and deploy for testing |
| PRODUCTION_DEPLOY   | Create a production package and deploy for release |
| SOLUTION            | Build the solution Release configuration  using dotnet build |
| SOLUTION_MSBUILD    | Build the solution Release configuration  using MSBuild |
| PACKAGE             | Create a packahe for the solution default is a zip file of all artifacts |
| COPY_ARTIFACTS      | Save the artifacts to the artifacts folder |
| DEPLOY              | Deploy the package. default is to extract artifacts into DeploymentProperty folder |
| TEST                | Run all tests using dotnet test in Release mode |
| TEST_DEBUG          | Run all tests using dotnet test in Debug mode |
| IS_ADMIN            | Check if current process is running in admin mode AdminCheckExitCode property is set |
| SingleProject       | Example how to build a single project |
| HandleError         | Error handling placeholder |


<Project InitialTargets="PROPERTIES" DefaultTargets="SOLUTION"
    xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!--
	- This is a common.targets file that can be used by any project.  Customizations is made by overriding
		the properties or targets in the project file.  The common.targets file is imported at the start of
		the project file, so any properties or targets defined in the project file will override the ones.
	- This file is imported by the project file using the following statement:
		<Import Project="common.targets" />
	- This is generated by nbuild.exe
    - @REM for more information, please visit <TBD>		
	Reference: https://learn.microsoft.com/en-us/visualstudio/msbuild/walkthrough-using-msbuild?view=vs-2022
	-->
	<UsingTask TaskName="NbuildTasks.ColorMessage" AssemblyFile="$(BuildTools)\NbuildTasks.dll"/>
	<UsingTask TaskName="NbuildTasks.RedError" AssemblyFile="$(BuildTools)\NbuildTasks.dll" />
	<UsingTask TaskName="NbuildTasks.Git" AssemblyFile="$(BuildTools)\NbuildTasks.dll" />

	<PropertyGroup>
		<!--The SolutionName should be replaced in nbuild.targets-->
    	<SolutionName></SolutionName>
		<DeploymentFolder></DeploymentFolder>
		<DevDrive>C:</DevDrive>
		<MainDir>Source</MainDir>
		<DevDir>$(DevDrive)\$(MainDir)</DevDir>
		<BuildTools>$(ProgramFiles)\nbuild</BuildTools>
		<CommonTargetsVersion>6.2.0</CommonTargetsVersion>
	</PropertyGroup>
	
	<Target Name="PROPERTIES" DependsOnTargets="GET_TAG">
		<PropertyGroup>
			<NbuildExe>"$(BuildTools)\ngit.exe"</NbuildExe>
			<NugetExe>$(BuildTools)\nuget.exe</NugetExe>
			<ZipExe>$(ProgramFiles)\BuildTools\7-Zip\7z.exe</ZipExe>
			<TargetRelease>Release</TargetRelease>
			<TargetDebug>Debug</TargetDebug>
			<SolutionDir>$(DevDir)\$(SolutionName)</SolutionDir>
			<OutputPathRelease>$(SolutionDir)\$(TargetRelease)</OutputPathRelease>
			<OutputPathDebug>$(SolutionDir)\$(TargetDebug)</OutputPathDebug>
			<ArtifactsDir>$(DevDrive)\Artifacts</ArtifactsDir>
			<TestFilesFolder>$(DevDrive)\Test</TestFilesFolder>
		</PropertyGroup>

		<RedError Condition="'$(ProductVersion)' == ''" Message="Error: Version property is not defined. Type Ngit.exe -c settag -tag 0.0.1" />
		<RedError Condition="'$(SolutionName)' == ''" Message="Error: SolutionName property is not defined." />
		<RedError Condition="'$(DeploymentFolder)' == ''" Message="Error: DeploymentFolder property is not defined." />

		<Message Text="CommonTargets Version: $(CommonTargetsVersion)"/>
		<Message Text="Solution Name: $(SolutionName)"/>
		<Message Text="Solution Dir: $(SolutionDir)"/>
		<Message Text="Product Version: $(ProductVersion)"/>
		<Exec Command="git remote -v"></Exec>
		<Exec Command="git branch"></Exec>
		<Exec Command="git describe" ConsoleToMSBuild="true"></Exec>
		<Message Text="MSBuild = $(MSBuildToolsPath) Version = VS$(VisualStudioVersion)"/>

		<Message Text="==> COMMON_DONE"/>
		<OnError ExecuteTargets="HandleError"/>
	</Target>

	<Target Name="CLEAN">
		<MSBuild Projects="$(SolutionDir)\$(SolutionName).sln" Targets="Clean" Properties="Configuration=$(TargetRelease);Platform=Any CPU" />
		<MSBuild Projects="$(SolutionDir)\$(SolutionName).sln" Targets="Clean" Properties="Configuration=$(TargetDebug);Platform=Any CPU"/>
		
		<RemoveDir Directories="$(OutputPathRelease);
                            $(OutputPathDebug);
                            $(SolutionDir)\x64;
							"/>

		<ItemGroup>
			<FilesToDelete Include="$(SolutionDir)\**\obj\**\*;$(SolutionDir)\**\bin\**\*" />
		</ItemGroup>
		<Delete Files="@(FilesToDelete)" />
		<RemoveDir Directories="$(SolutionDir)\**\obj" />
		<ItemGroup>
			<DirectoriesToDelete Include="$(SolutionDir)\**\obj\**\*;$(SolutionDir)\**\bin\**\*" />
		</ItemGroup>
		<RemoveDir Directories="@(DirectoriesToDelete)" />

		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="STAGING" DependsOnTargets="
                CLEAN;
                GET_TAG;
                AUTOTAG_STAGING;
                SOLUTION;
                TEST;
                SAVE_ARTIFACTS;
                PACKAGE">
  </Target>

  <!-- Perform a production release -->
  <Target Name="PRODUCTION" DependsOnTargets="
                CLEAN;
                GIT_PULL;
                GET_TAG;
                AUTOTAG_PRODUCTION;
                SOLUTION;
                TEST;
                SAVE_ARTIFACTS;
                PACKAGE">
  
  </Target>


	<Target Name="STAGING_DEPLOY" DependsOnTargets="
                            STAGING;
                            DEPLOY">
		<Message Text="==> COMMON_DONE"/>
	</Target>
	
	
	
	<Target Name="PRODUCTION_DEPLOY" DependsOnTargets="
                            PRODUCTION;
                            DEPLOY">
		<Message Text="==> COMMON_DONE"/>
	</Target>
	


	<Target Name="SOLUTION" DependsOnTargets="GET_TAG">
		<Message Text="Git tag: $(ProductVersion)"/>
		<Exec Command='dotnet build $(SolutionDir)\$(SolutionName).sln --configuration $(TargetRelease) /p:FileVersion=$(ProductVersion) /p:AssemblyVersion=$(ProductVersion) /p:UICulture="en-US" /p:Culture="en-US"' ></Exec>
		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="SOLUTION_MSBUILD">
		<Exec Command="dotnet restore"></Exec>
		<MSBuild Projects="$(SolutionDir)\$(SolutionName).sln" Properties="Configuration=$(TargetRelease);Platform=Any CPU;Version=$(ProductVersion);AssemblyVersion=$(ProductVersion);UICulture=en-US;Culture=en-US"/>
		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="PACKAGE" DependsOnTargets="ARTIFACTS;GET_TAG">
		<Exec Command='"$(ZipExe)" a -r -tzip $(ArtifactsFolder).zip $(ArtifactsFolder)\*'/>
		<RemoveDir Directories="$(ArtifactsFolder);
							"/> 
		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="SAVE_ARTIFACTS" DependsOnTargets="ARTIFACTS;GET_TAG">
		<Error Condition="'$(ArtifactsFolder)' == ''" Text="Error: ArtifactsFolder property is not defined." />
		<Message Text="ArtifactsFolder: $(ArtifactsFolder)"/>

		
		<Copy SourceFiles="@(BinaryFiles)"
			  DestinationFolder="$(ArtifactsFolder)"
			  Condition="'@(BinaryFiles, ' ')' != ''"
			  SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(EnUSFiles)"
			DestinationFolder="$(ArtifactsFolder)\en-US"
			Condition="'@(EnUSFiles, ' ')' != ''"
			SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(ref)"
		  DestinationFolder="$(ArtifactsFolder)\ref"
		  Condition="'@(ref, ' ')' != ''"
			  SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(RunTimesLib)"
			  DestinationFolder="$(ArtifactsFolder)\runtimes\win\lib\netstandard2.0"
			  Condition="'@(RunTimesLib, ' ')' != ''"
			  SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(Default)"
			  DestinationFolder="$(ArtifactsFolder)\Default"
			  Condition="'@(Default, ' ')' != ''"
			  SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(RunTimesLibNet)"
			  DestinationFolder="$(ArtifactsFolder)\runtimes\win\lib\net8.0"
			  Condition="'@(RunTimesLibNet, ' ')' != ''"
			  SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(RunTimesNetStandard20)"
			DestinationFolder="$(ArtifactsFolder)\netstandard2.0\"
			Condition="'@(RunTimesNetStandard20, ' ')' != ''"
			SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(RunTimesNetStandard21)"
			DestinationFolder="$(ArtifactsFolder)\netstandard2.1\"
			Condition="'@(RunTimesNetStandard21, ' ')' != ''"
			SkipUnchangedFiles="true" />

		<Copy SourceFiles="@(RunTimesNative)"
			DestinationFolder="$(ArtifactsFolder)\runtimes\win\native\"
			Condition="'@(RunTimesNative, ' ')' != ''"
			SkipUnchangedFiles="true" />

		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="DEPLOY" DependsOnTargets="IS_ADMIN;ARTIFACTS">
		<RedError Condition="'$(IsAdmin)' == false" Message="Must be an admin to deploy project: '$(SolutionName)'." />
		<RedError Condition="'$(DeploymentFolder)' == ''" Message="Error: DeploymentFolder property is not defined." />
		<Message Text="DeploymentFolder: $(DeploymentFolder)"/>

		<PropertyGroup>
			<SetupDir>$(TEMP)\home</SetupDir>
		</PropertyGroup>
		
		<Exec Command='"$(ZipExe)" x $(ArtifactsFolder).zip -o"$(DeploymentFolder)" -y'/>

		<RemoveDir Directories="$(SetupDir)"></RemoveDir>
		<Message Text="Deployed Success to $(DeploymentFolder)"/>
		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="TEST" DependsOnTargets="ARTIFACTS;GET_TAG">
		<RemoveDir Directories="$(ArtifactsTestResultsFolder)"></RemoveDir>
		<!--To colllect code coverage, add the following option to the test command: --collect:"XPlat Code Coverage"-->
		<Exec Command='"c:\program files\dotnet\dotnet.exe" test --configuration $(TargetDebug) --logger "console;verbosity=normal;DOTNET_CLI_TELEMETRY_OPTOUT=1" %(DotNetTestFiles.Identity) --logger trx --results-directory:$(ArtifactsTestResultsFolder) --verbosity normal'/>
		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="TEST_RELEASE" DependsOnTargets="ARTIFACTS;GET_TAG">
		<Exec Command='"c:\program files\dotnet\dotnet.exe" test --configuration $(TargetRelease) --logger "console;verbosity=normal;DOTNET_CLI_TELEMETRY_OPTOUT=1" %(DotNetTestFiles.Identity) --collect:"XPlat Code Coverage" --logger trx --results-directory:$(ArtifactsTestResultsFolder) --verbosity normal'/>
		<Message Text="==> COMMON_DONE"/>
	</Target>

	<Target Name="IS_ADMIN">
	    <Exec Command="net session" ContinueOnError="true">
			<Output TaskParameter="ExitCode" PropertyName="AdminCheckExitCode"/>
		</Exec>
		
		<PropertyGroup>
			<IsAdmin Condition="'$(AdminCheckExitCode)' == '0'">true</IsAdmin>
			<IsAdmin Condition="'$(AdminCheckExitCode)' != '0'">false</IsAdmin>
		</PropertyGroup>

		<Message Text="IsAdmin: $(IsAdmin)" />
	</Target>

	<!--Git targets Start-->

		<!-- Display the current git status -->
		<Target Name="GIT_STATUS" >

			<Exec Command='git status --porcelain' ConsoleToMSBuild="true">
				<Output TaskParameter="ConsoleOutput" PropertyName="GitStatus" />
			</Exec>
			<Message Importance="high" Text="Git Status: $(GitStatus)" />

			<Message Text="==> COMMON_DONE"/>
		</Target>

		<!-- Increment version for a staging build -->
		<Target Name="AUTOTAG_STAGING">
			<!--
			<Exec Command='$(NbuildExe) -c autotag  -buildtype staging' ConsoleToMSBuild="true">
				<Output TaskParameter="ConsoleOutput" PropertyName="ProductVersion" />
			</Exec>
			-->

			<Git Command="AutoTag" TaskParameter="Staging">
				<Output TaskParameter="Output" PropertyName="ProductVersion"/>
			</Git>
			<Message Text="Task - Git Next Tag:'$(ProductVersion)'"/>

			<RedError Condition="'$(ProductVersion)' == ''" Message="AutoTag Staging Failed: Product Version property is not defined." />

			<Message Text="==> COMMON_DONE"/>
		</Target>


		<!-- Set version for a staging build -->
		<Target Name="SET_TAG" AfterTargets="AUTOTAG_STAGING;AUTOTAG_PRODUCTION">
			<Message Text="Git Next tag: $(ProductVersion)"/>

			<!-- <Exec Command='$(NbuildExe) -c settag  -tag $(ProductVersion)' ConsoleToMSBuild="true">
		  <Output TaskParameter="ConsoleOutput" PropertyName="Result" />
	  </Exec> -->

			<Git Command="SetTag" TaskParameter="$(ProductVersion)">
				<Output TaskParameter="Output" PropertyName="ProductVersion"/>
			</Git>
			<Message Text="Task - Git Next Tag:'$(ProductVersion)'"/>

			<RedError Condition="'$(ProductVersion)' == ''" Message="SetTag Failed: Product Version property is not defined." />

			<Message Text="==> COMMON_DONE"/>
		</Target>

		<!-- Get the latest tag from git -->
		<Target Name="GIT_PULL" DependsOnTargets="GIT_BRANCH">
			<Exec Command='git pull -r'/>
		</Target>

		<Target Name="AUTOTAG_PRODUCTION" DependsOnTargets="GIT_BRANCH">
			<RedError Condition="'$(GitBranch)' != 'main'" Message="Error: Must be on main branch for a production release." />

			<!-- 
				<Exec Command='$(NbuildExe) -c autotag  -buildtype production' ConsoleToMSBuild="true">
		  			<Output TaskParameter="ConsoleOutput" PropertyName="ProductVersion" />
	  			</Exec> 
			-->

			<Git Command="AutoTag" TaskParameter="Production">
				<Output TaskParameter="Output" PropertyName="ProductVersion"/>
			</Git>
			<Message Text="Task - Git Next Tag:'$(ProductVersion)'"/>

			<RedError Condition="'$(ProductVersion)' == ''" Message="AutoTag Production Failed: Product Version property is not defined." />
			<Message Text="==> COMMON_DONE"/>
		</Target>

		<Target Name="GET_TAG">
			<!-- 
				<Exec Command='$(NbuildExe) -c gettag ' ConsoleToMSBuild="true">
		  			<Output TaskParameter="ConsoleOutput" PropertyName="ProductVersion" />
	  			</Exec>
	  			<Message Text="Git tag: $(ProductVersion)"/> 
			-->

			<Git Command="GetTag" >
				<Output TaskParameter="Output" PropertyName="ProductVersion"/>
			</Git>
			<Message Text="Task - Git Tag:'$(ProductVersion)'"/>

			<RedError Condition="'$(ProductVersion)' == ''" Message="GetTag Failed: Product Version property is not defined." />
			<Message Text="==> COMMON_DONE"/>
		</Target>

		<Target Name="PUSH_TAG" DependsOnTargets="GIT_BRANCH;GET_TAG">

			<Git Command="PushTag" TaskParameter="$(ProductVersion)">
				<Output TaskParameter="Output" PropertyName="Result"/>
			</Git>

			<Message Text="Task - Git Push Tag Result:'$(Result)'"/>

			<RedError Condition="'$(Result)' != 'True'" Message="DeteteTag Failed: Product Version property is not defined." />

			<Message Text="==> COMMON_DONE"/>
		</Target>

		<Target Name="GIT_BRANCH">
			<!-- <Exec Command='$(NbuildExe) -c getbranch' ConsoleToMSBuild="true">
		  <Output TaskParameter="ConsoleOutput" PropertyName="GitBranch" />
	  </Exec>

	  <Message Text="Git Branch: $(GitBranch)"/> -->

			<Git Command="GetBranch">
				<Output TaskParameter="Output" PropertyName="GitBranch"/>
			</Git>
			<Message Text="Task - Git Branch:'$(GitBranch)'"/>

			<RedError Condition="'$(GitBranch)' == ''" Message="GetBranch Failed: GitBranch property is not defined." />


			<Message Text="==> COMMON_DONE"/>
		</Target>
		<!--Git Targets End-->


	<Target Name="SingleProject">
		<Exec Command='dotnet build $(SolutionDir)\nbuild\nbuild.csproj --configuration $(TargetRelease) --runtime win-x64 /p:FileVersion=$(ProductVersion) /p:AssemblyVersion=$(ProductVersion)'></Exec>
	</Target>

	<Target Name="HandleError">
		<Message Text="An error occurred while reading the version file." Importance="high"/>
	</Target>	
</Project>
